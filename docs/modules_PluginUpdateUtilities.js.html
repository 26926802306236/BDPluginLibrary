<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: modules/PluginUpdateUtilities.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: modules/PluginUpdateUtilities.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import PluginUtilities from "./PluginUtilities";
import DiscordModules from "./discordmodules";
import Logger from "./logger";
import {$} from "../vendor";

/**
 * Functions that check for and update existing plugins.
 * @module PluginUpdateUtilities
 * @version 0.0.3
 */
var PluginUpdateUtilities = {};

/**
 * Creates the update button found in the plugins page of BetterDiscord
 * settings. Returned button will already have listeners to create the tooltip.
 * @returns {HTMLElement} check for update button
 */
PluginUpdateUtilities.createUpdateButton = function() {
	var updateButton = document.createElement("button");
	updateButton.className = "bd-pfbtn bd-updatebtn";
	updateButton.innerText = "Check for Updates";
	updateButton.style.left = "220px";
	updateButton.onclick = function () {
		window.PluginUpdates.checkAll();
	};
	let tooltip = new PluginTooltip.Tooltip($(updateButton), "Checks for updates of plugins that support this feature. Right-click for a list.");
	updateButton.oncontextmenu = function () {
		if (window.PluginUpdates &amp;&amp; window.PluginUpdates.plugins) {
			var list = [];
			for (var plugin in window.PluginUpdates.plugins) {
				list.push(window.PluginUpdates.plugins[plugin].name);
			}
			tooltip.tooltip.detach();
			tooltip.tooltip.text(list.join(", "));
			tooltip.show();
			updateButton.onmouseout = function() { tooltip.tooltip.text(tooltip.tip); };
		}
	};
	return updateButton;
};

PluginUpdateUtilities.getCSS = function () {
	return require("../styles/updates.css");
};

/**
 * Will check for updates and automatically show or remove the update notice
 * bar based on the internal result. Better not to call this directly and to
 * instead use {@link PluginUtilities.checkForUpdate}.
 * @param {string} pluginName - name of the plugin to check
 * @param {string} updateLink - link to the raw text version of the plugin
 */
PluginUpdateUtilities.checkUpdate = function(pluginName, updateLink) {
	let request = require("request");
	request(updateLink, (error, response, result) => {
		if (error) return;
		var remoteVersion = result.match(/['"][0-9]+\.[0-9]+\.[0-9]+['"]/i);
		if (!remoteVersion) return;
		remoteVersion = remoteVersion.toString().replace(/['"]/g, "");
		var ver = remoteVersion.split(".").map((e) => {return parseInt(e);});
		var lver = window.PluginUpdates.plugins[updateLink].version.split(".").map((e) => {return parseInt(e);});
		var hasUpdate = false;
		if (ver[0] > lver[0]) hasUpdate = true;
		else if (ver[0] == lver[0] &amp;&amp; ver[1] > lver[1]) hasUpdate = true;
		else if (ver[0] == lver[0] &amp;&amp; ver[1] == lver[1] &amp;&amp; ver[2] > lver[2]) hasUpdate = true;
		else hasUpdate = false;
		if (hasUpdate) PluginUpdateUtilities.showUpdateNotice(pluginName, updateLink);
		else PluginUpdateUtilities.removeUpdateNotice(pluginName);
	});
};

/**
 * Will show the update notice top bar seen in Discord. Better not to call
 * this directly and to instead use {@link PluginUtilities.checkForUpdate}.
 * @param {string} pluginName - name of the plugin
 * @param {string} updateLink - link to the raw text version of the plugin
 */
PluginUpdateUtilities.showUpdateNotice = function(pluginName, updateLink) {
	if (!$('#pluginNotice').length)  {
		let noticeElement = `&lt;div class="${DiscordModules.NoticeBarClasses.notice} ${DiscordModules.NoticeBarClasses.noticeInfo}" id="pluginNotice">&lt;div class="${DiscordModules.NoticeBarClasses.dismiss}" id="pluginNoticeDismiss">&lt;/div>&lt;span class="notice-message">The following plugins have updates:&lt;/span>&amp;nbsp;&amp;nbsp;&lt;strong id="outdatedPlugins">&lt;/strong>&lt;/div>`;
		// $('.app .guilds-wrapper + div > div:first > div:first').append(noticeElement);
		$('.app.flex-vertical').children().first().before(noticeElement);
        $('.win-buttons').addClass("win-buttons-notice");
		$('#pluginNoticeDismiss').on('click', () => {
			$('.win-buttons').animate({top: 0}, 400, "swing", () => { $('.win-buttons').css("top","").removeClass("win-buttons-notice"); });
			$('#pluginNotice').slideUp({complete: () => { $('#pluginNotice').remove(); }});
		});
	}
	let pluginNoticeID = pluginName + '-notice';
	if (!$('#' + pluginNoticeID).length) {
		let pluginNoticeElement = $('&lt;span id="' + pluginNoticeID + '">');
        pluginNoticeElement.text(pluginName);
        pluginNoticeElement.on('click', () => {
            PluginUpdateUtilities.downloadPlugin(pluginName, updateLink);
        });
		if ($('#outdatedPlugins').children('span').length) $('#outdatedPlugins').append("&lt;span class='separator'>, &lt;/span>");
		$('#outdatedPlugins').append(pluginNoticeElement);
	}
};

/**
 * Will download the latest version and replace the the old plugin version.
 * Will also update the button in the update bar depending on if the user
 * is using RestartNoMore plugin by square {@link https://github.com/Inve1951/BetterDiscordStuff/blob/master/plugins/restartNoMore.plugin.js}
 * @param {string} pluginName - name of the plugin to download
 * @param {string} updateLink - link to the raw text version of the plugin
 */
PluginUpdateUtilities.downloadPlugin = function(pluginName, updateLink) {
    let request = require("request");
    let fileSystem = require("fs");
    let path = require("path");
    request(updateLink, (error, response, body) => {
        if (error) return Logger.warn("PluginUpdates", "Unable to get update for " + pluginName);
        let remoteVersion = body.match(/['"][0-9]+\.[0-9]+\.[0-9]+['"]/i);
        remoteVersion = remoteVersion.toString().replace(/['"]/g, "");
        let filename = updateLink.split('/');
        filename = filename[filename.length - 1];
        var file = path.join(PluginUtilities.getPluginsFolder(), filename);
        fileSystem.writeFileSync(file, body);
		PluginUtilities.showToast(`${pluginName} ${window.PluginUpdates.plugins[updateLink].version} has been replaced by ${pluginName} ${remoteVersion}`);
		let oldRNM = window.bdplugins["Restart-No-More"] &amp;&amp; window.pluginCookie["Restart-No-More"];
		let newRNM = window.bdplugins["Restart No More"] &amp;&amp; window.pluginCookie["Restart No More"];
        if (!(oldRNM || newRNM)) {
            if (!window.PluginUpdates.downloaded) {
                window.PluginUpdates.downloaded = [];
                let button = $(`&lt;button class="btn btn-reload ${DiscordModules.NoticeBarClasses.btn} ${DiscordModules.NoticeBarClasses.button}">Reload&lt;/button>`);
                button.on('click', (e) => {
                    e.preventDefault();
                    window.location.reload(false);
                });
                var tooltip = document.createElement("div");
                tooltip.className = "tooltip tooltip-bottom tooltip-black";
                tooltip.style.maxWidth = "400px";
                button.on('mouseenter', () => {
                    document.querySelector(".tooltips").appendChild(tooltip);
                    tooltip.innerText = window.PluginUpdates.downloaded.join(", ");
                    tooltip.style.left = button.offset().left + (button.outerWidth() / 2) - ($(tooltip).outerWidth() / 2) + "px";
                    tooltip.style.top = button.offset().top + button.outerHeight() + "px";
                });
    
                button.on('mouseleave', () => {
                    tooltip.remove();
                });
    
                button.appendTo($('#pluginNotice'));
            }
            window.PluginUpdates.plugins[updateLink].version = remoteVersion;
            window.PluginUpdates.downloaded.push(pluginName);
            PluginUpdateUtilities.removeUpdateNotice(pluginName);
        }
    });
};

/**
 * Will remove the plugin from the update notice top bar seen in Discord.
 * Better not to call this directly and to instead use {@link PluginUtilities.checkForUpdate}.
 * @param {string} pluginName - name of the plugin
 */
PluginUpdateUtilities.removeUpdateNotice = function(pluginName) {
	let notice = $('#' + pluginName + '-notice');
	if (notice.length) {
		if (notice.next('.separator').length) notice.next().remove();
		else if (notice.prev('.separator').length) notice.prev().remove();
		notice.remove();
    }

	if (!$('#outdatedPlugins').children('span').length &amp;&amp; !$('#pluginNotice .btn-reload').length) {
        $('#pluginNoticeDismiss').click();
    } 
    else if (!$('#outdatedPlugins').children('span').length &amp;&amp; $('#pluginNotice .btn-reload').length) {
        $('#pluginNotice .notice-message').text("To finish updating you need to reload.");
    }
};

export default PluginUpdateUtilities;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-ColorConverter.html">ColorConverter</a></li><li><a href="module-DiscordAPI.html">DiscordAPI</a></li><li><a href="module-DiscordClassModules.html">DiscordClassModules</a></li><li><a href="module-DiscordModules.html">DiscordModules</a></li><li><a href="module-DOMTools.html">DOMTools</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-Patcher.html">Patcher</a></li><li><a href="module-PluginContextMenu.html">PluginContextMenu</a></li><li><a href="module-PluginSettings.html">PluginSettings</a></li><li><a href="module-PluginTooltip.html">PluginTooltip</a></li><li><a href="module-PluginUpdateUtilities.html">PluginUpdateUtilities</a></li><li><a href="module-PluginUtilities.html">PluginUtilities</a></li><li><a href="module-ReactTools.html">ReactTools</a></li><li><a href="module-Utilities.html">Utilities</a></li></ul><h3>Classes</h3><ul><li><a href="DiscordPermissions.html">DiscordPermissions</a></li><li><a href="module-DOMTools.ClassName.html">ClassName</a></li><li><a href="module-DOMTools.Selector.html">Selector</a></li><li><a href="module-PluginContextMenu.ImageItem.html">ImageItem</a></li><li><a href="module-PluginContextMenu.ItemGroup.html">ItemGroup</a></li><li><a href="module-PluginContextMenu.Menu.html">Menu</a></li><li><a href="module-PluginContextMenu.MenuItem.html">MenuItem</a></li><li><a href="module-PluginContextMenu.SubMenuItem.html">SubMenuItem</a></li><li><a href="module-PluginContextMenu.TextItem.html">TextItem</a></li><li><a href="module-PluginContextMenu.ToggleItem.html">ToggleItem</a></li><li><a href="module-PluginSettings.ColorPicker.html">ColorPicker</a></li><li><a href="module-PluginSettings.Pill.html">Pill</a></li><li><a href="module-PluginSettings.SettingField.html">SettingField</a></li><li><a href="module-PluginSettings.SettingGroup.html">SettingGroup</a></li><li><a href="module-PluginSettings.Slider.html">Slider</a></li><li><a href="module-PluginSettings.Switch.html">Switch</a></li><li><a href="module-PluginSettings.Textbox.html">Textbox</a></li><li><a href="module-PluginTooltip.NativeTooltip.html">NativeTooltip</a></li><li><a href="module-PluginTooltip.PluginTooltip.html">PluginTooltip</a></li><li><a href="Screen.html">Screen</a></li></ul><h3>Global</h3><ul><li><a href="global.html#getAccentColor">getAccentColor</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri May 18 2018 00:25:55 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
